rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Get user role from custom claims
    function getUserRole() {
      return request.auth.token.role;
    }
    
    // Check if user is admin or superadmin
    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'superadmin'];
    }
    
    // Check if user is superadmin
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'superadmin';
    }
    
    // Validate string length
    function validStringLength(value, min, max) {
      return value is string && value.size() >= min && value.size() <= max;
    }
    
    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    match /users/{userId} {
      // Users can read their own data
      // Admins can read any user data
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own profile (on signup)
      allow create: if isOwner(userId) 
                    && hasRequiredFields(['uid', 'email', 'role', 'createdAt'])
                    && request.resource.data.uid == userId
                    && request.resource.data.role == 'customer' // Cannot self-assign admin role
                    && (!('addresses' in request.resource.data) || request.resource.data.addresses.size() == 0); // Start with empty addresses
      
      // Users can update their own profile (except role and uid)
      // Admins can update any user
      // ENHANCED: Validate addresses array if being updated
      allow update: if ((isOwner(userId) 
                       && !('role' in request.resource.data.diff(resource.data).affectedKeys())
                       && !('uid' in request.resource.data.diff(resource.data).affectedKeys())
                       && addressesValid())
                    || isAdmin());
      
      // Only superadmin can delete users
      allow delete: if isSuperAdmin();
      
      // Helper function to validate addresses array
      function addressesValid() {
        // If addresses field is not being updated, allow
        return !('addresses' in request.resource.data) 
               || (
                 // Max 10 addresses
                 request.resource.data.addresses.size() <= 10
                 
                 // Only one default address (simple check - count isDefault:true)
                 && (request.resource.data.addresses.size() == 0 
                     || onlyOneDefaultAddress(request.resource.data.addresses))
               );
      }
      
      // Count default addresses - must be 0 or 1
      function onlyOneDefaultAddress(addresses) {
        return addresses.toSet().hasAll([{'isDefault': true}]) == false
               || addresses.where('isDefault', '==', true).size() <= 1;
      }
    }
    
    // ============================================================================
    // PRODUCTS COLLECTION
    // ============================================================================
    match /products/{productId} {
      // Anyone can read products (public catalog)
      allow read: if true;
      
      // Only admins can create products
      allow create: if isAdmin()
                    && hasRequiredFields([
                      'title', 'description', 'basePrice', 'price', 
                      'discountType', 'discountValue', 'category', 
                      'sizes', 'stockBySize', 'inStock', 'images', 'createdAt'
                    ])
                    && request.resource.data.basePrice is number
                    && request.resource.data.basePrice > 0
                    && request.resource.data.price is number
                    && request.resource.data.price > 0
                    && validStringLength(request.resource.data.title, 3, 200)
                    && validStringLength(request.resource.data.description, 10, 2000);
      
      // Only admins can update products
      allow update: if isAdmin();
      
      // Only admins can delete products
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // ORDERS COLLECTION
    // ============================================================================
    match /orders/{orderId} {
      // Users can read their own orders
      // Admins can read all orders
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Users can create orders for themselves
      allow create: if isAuthenticated()
                    && hasRequiredFields([
                      'userId', 'items', 'totalAmount', 
                      'paymentStatus', 'orderStatus', 'address', 'createdAt'
                    ])
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.paymentStatus == 'pending'
                    && request.resource.data.orderStatus == 'placed'
                    && request.resource.data.totalAmount is number
                    && request.resource.data.totalAmount > 0
                    && request.resource.data.totalAmount <= 10000000 // Max 1 crore
                    && request.resource.data.items is list
                    && request.resource.data.items.size() > 0
                    && request.resource.data.items.size() <= 100; // Max 100 items per order
      
      // Users can update their own orders (for payment verification)
      // But cannot change userId, totalAmount, or items after creation
      // Admins can update any order
      allow update: if (isOwner(resource.data.userId)
                       && !('userId' in request.resource.data.diff(resource.data).affectedKeys())
                       && !('totalAmount' in request.resource.data.diff(resource.data).affectedKeys())
                       && !('items' in request.resource.data.diff(resource.data).affectedKeys()))
                    || isAdmin();
      
      // Only admins can delete orders
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // SETTINGS COLLECTION
    // ============================================================================
    match /settings/{settingId} {
      // Anyone can read settings (for shipping calculations)
      allow read: if true;
      
      // Only admins can create settings
      allow create: if isAdmin();
      
      // Only admins can update settings
      allow update: if isAdmin();
      
      // Only superadmin can delete settings
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================================
    // COMBOS COLLECTION
    // ============================================================================
    match /combos/{comboId} {
      // Anyone can read active combos
      // Admins can read all combos
      allow read: if resource.data.active == true || isAdmin();
      
      // Only admins can create combos
      allow create: if isAdmin()
                    && hasRequiredFields([
                      'name', 'type', 'minimumQuantity', 'comboPrice',
                      'active', 'startDate', 'createdAt', 'createdBy'
                    ])
                    && request.resource.data.minimumQuantity is number
                    && request.resource.data.minimumQuantity > 0
                    && request.resource.data.comboPrice is number
                    && request.resource.data.comboPrice > 0
                    && request.resource.data.createdBy == request.auth.uid;
      
      // Only admins can update combos
      allow update: if isAdmin();
      
      // Only admins can delete combos
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // COMBO ANALYTICS EVENTS COLLECTION
    // ============================================================================
    match /comboAnalyticsEvents/{eventId} {
      // Only admins can read analytics
      allow read: if isAdmin();
      
      // System can create events (authenticated users for tracking)
      allow create: if isAuthenticated()
                    && hasRequiredFields(['comboId', 'event', 'metadata', 'timestamp']);
      
      // No updates or deletes allowed
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================================================
    // PIN CODES COLLECTION (Shipping serviceability)
    // ============================================================================
    match /pincodes/{pincodeId} {
      // Anyone can read pincode data (for shipping calculations)
      allow read: if true;
      
      // Only admins can create/update pincodes
      allow create: if isAdmin();
      allow update: if isAdmin();
      
      // Only superadmin can delete pincodes
      allow delete: if isSuperAdmin();
    }
  }
}
